# CI runs when a PR is opened/ready or before merging.
#
#  | Event                           | When                       |
#  |---------------------------------|----------------------------|
#  | pull_request (opened)           | PR created (draft or not)  |
#  | pull_request (ready_for_review) | Draft PR marked ready      |
#  | merge_group                     | Merge queue (before merge) |
#  | workflow_dispatch               | Manual trigger             |
#
# Note: `synchronize` is intentionally omitted to avoid workflow runs on
# every push.

name: ci
on:
  pull_request:
    types: [opened, ready_for_review]
    branches:
      - main
  merge_group:
  workflow_dispatch:
permissions:
  contents: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  fmt:
    name: nightly / fmt
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Install nightly
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # branch=master
        id: toolchain
        with:
          toolchain: nightly
          components: rustfmt
      - name: Toolchain override
        run: rustup override set "${TOOLCHAIN}"
        env:
          TOOLCHAIN: ${{steps.toolchain.outputs.name}}
      - name: cargo fmt --all --check
        run: cargo fmt --all --check
  lint:
    name: nightly / clippy, test and docs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          toolchain: nightly
          components: clippy
          shared-key: lint-all-features
      - name: cargo clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings
      - name: Install cargo-hack
        uses: taiki-e/install-action@b9c5db3aef04caffaf95a1d03931de10fb2a140f # tag: v2.65.1
        with:
          tool: cargo-hack
      - name: cargo hack
        run: cargo hack --feature-powerset check --locked
      - name: cargo test
        run: cargo test --locked --all-features
      - name: Check Documentation
        run: cargo doc --locked --no-deps --workspace --all-features --document-private-items
        env:
          RUSTDOCFLAGS: -D warnings
  build:
    name: stable / build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          toolchain: stable
          shared-key: build-release
      - name: cargo build --release
        run: cargo build --release --locked
  msrv:
    name: MSRV / 1.88.0
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Setup Rust build environment
        uses: ./.github/actions/setup-rust-build
        with:
          toolchain: "1.88.0"
          shared-key: msrv
      - name: cargo check
        run: cargo check --locked --all-targets --all-features
  cargo-deny:
    name: Check licenses & security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Setup patched dependencies
        uses: ./.github/actions/setup-patched-deps
      - name: Check licenses
        uses: EmbarkStudios/cargo-deny-action@76cd80eb775d7bbbd2d80292136d74d39e1b4918 # tag: v2.0.14
        with:
          command: check licenses
      - name: Install cargo-audit
        uses: taiki-e/install-action@b9c5db3aef04caffaf95a1d03931de10fb2a140f # tag: v2.65.1
        with:
          tool: cargo-audit
      - name: cargo audit
        run: cargo audit
  machete:
    name: Check unused dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Install cargo-machete
        uses: taiki-e/install-action@b9c5db3aef04caffaf95a1d03931de10fb2a140f # tag: v2.65.1
        with:
          tool: cargo-machete
      - name: cargo machete
        run: cargo machete
  toml-fmt:
    name: toml fmt
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Install taplo
        uses: taiki-e/install-action@b9c5db3aef04caffaf95a1d03931de10fb2a140f # tag: v2.65.1
        with:
          tool: taplo
      - name: taplo fmt --check
        run: taplo fmt --check
  markdown-lint:
    name: markdown lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Lint markdown
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # tag: v22.0.0
  yaml-lint:
    name: yaml lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Lint YAML
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # tag: v3.1.1
  typos:
    name: typos
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # tag: v6.0.1
      - name: Check typos
        uses: crate-ci/typos@2d0ce569feab1f8752f1dde43cc2f2aa53236e06 # tag: v1.40.0
